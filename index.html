<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>下班了吗</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen flex items-center justify-center bg-gradient-to-br from-pink-400 via-purple-400 to-green-300">
<div class="w-full max-w-md p-6">
  <div class="bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl p-6 space-y-6">

    <header>
      <h1 class="text-4xl font-black">下班了吗</h1>
      <p class="text-sm text-neutral-600 mt-1">一种不打扰的关心方式</p>
    </header>

    <section id="statusList" class="space-y-4"></section>

    <section class="space-y-3 pt-2">
      <h2 class="font-semibold">我现在是</h2>
      <div id="statusButtons" class="grid grid-cols-3 gap-2"></div>

      <div class="flex items-center gap-2">
        <span class="text-sm">最早几点跑：</span>
        <input id="timeInput" type="time"
          class="flex-1 rounded-xl border px-3 py-2" />
      </div>

      <button id="updateBtn"
        class="w-full rounded-2xl bg-black text-white py-3 font-semibold">
        更新状态
      </button>
    </section>

    <footer class="text-xs text-center text-neutral-500 pt-2">
      多巴胺仍在分泌中
    </footer>

  </div>
</div>

<script>
const SUPABASE_URL = 'https://pwfglucsclutdrwnhuhz.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3ZmdsdWNzY2x1dGRyd25odWh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0ODMwOTAsImV4cCI6MjA4NDA1OTA5MH0.5OLlw_rzO3SaQZqDHeZ8_iBwlJgNOtQMa3OlhdpAzrM';


const params = new URLSearchParams(location.search);
const ROOM_SECRET = params.get('room');
if (!ROOM_SECRET) {
  alert('缺少房间链接');
  throw new Error('no room');
}

let ROLE = localStorage.getItem('offwork_role');
if (!ROLE) {
  ROLE = confirm('你是「我」吗？') ? 'me' : 'ta';
  localStorage.setItem('offwork_role', ROLE);
}

let MY_MEMBER_ID = null;

function headers(extra = {}) {
  return {
    apikey: SUPABASE_KEY,
    Authorization: `Bearer ${SUPABASE_KEY}`,
    'Content-Type': 'application/json',
    'request.jwt.claim.secret': ROOM_SECRET,
    ...extra
  };
}

async function init() {
  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/couple_members?select=id,role,display_name`,
    { headers: headers() }
  );
  const members = await res.json();
  const me = members.find(m => m.role === ROLE);
  if (!me) {
    alert('身份不匹配');
    return;
  }
  MY_MEMBER_ID = me.id;
  fetchStatus();
}

async function fetchStatus() {
  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/offwork_status?select=member_id,status,offwork_time,updated_at,couple_members(display_name,role)`,
    { headers: headers() }
  );
  const data = await res.json();
  render(data);
}

function render(list) {
  const el = document.getElementById('statusList');
  el.innerHTML = '';
  list
    .sort((a,b)=>a.couple_members.role==='me'?-1:1)
    .forEach(item => {
      const isMe = item.member_id === MY_MEMBER_ID;
      el.innerHTML += `
        <div class="rounded-2xl p-4 bg-white ${isMe?'ring-2 ring-black':''}">
          <div class="font-bold text-xl">${item.couple_members.display_name}</div>
          <div>${item.status || '状态未知'}</div>
          <div class="text-sm">最早下班：${item.offwork_time || '未知'}</div>
        </div>
      `;
    });
}

document.getElementById('updateBtn').onclick = async () => {
  const time = document.getElementById('timeInput').value;
  await fetch(
    `${SUPABASE_URL}/rest/v1/offwork_status?member_id=eq.${MY_MEMBER_ID}`,
    {
      method: 'PATCH',
      headers: headers({
        'request.jwt.claim.member_id': MY_MEMBER_ID
      }),
      body: JSON.stringify({
        status: document.querySelector('#statusButtons .bg-black')?.innerText,
        offwork_time: time,
        updated_at: new Date().toISOString()
      })
    }
  );
  fetchStatus();
};

init();
</script>
</body>
</html>
