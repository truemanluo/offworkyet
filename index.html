<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>ä¸‹ç­äº†å—</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(135deg, #ff6ec4, #7873f5, #4ade80);
      background-size: 400% 400%;
      animation: gradientMove 15s ease infinite;
    }
    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center text-neutral-900">
  <div class="w-full max-w-md p-6">
    <div class="bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl p-6 space-y-6">
      <header class="space-y-2">
        <h1 class="text-4xl font-black tracking-tight">ä¸‹ç­äº†å—</h1>
        <p class="text-sm text-neutral-600">ä¸€ç§ä¸æ‰“æ‰°çš„å…³å¿ƒæ–¹å¼</p>
      </header>

      <section id="statusList" class="space-y-4"></section>

      <section class="pt-2 space-y-3">
        <h2 class="text-lg font-semibold">æˆ‘ç°åœ¨æ˜¯</h2>
        <div id="statusButtons" class="grid grid-cols-3 gap-2"></div>

        <div class="flex items-center gap-2">
          <span class="text-sm">æœ€æ—©å‡ ç‚¹è·‘ï¼š</span>
          <input id="timeInput" type="time" class="flex-1 rounded-xl border px-3 py-2" />
        </div>

        <button id="updateBtn" class="w-full rounded-2xl bg-black text-white py-3 font-semibold active:scale-95 transition">
          æ›´æ–°çŠ¶æ€
        </button>
      </section>

      <footer class="text-xs text-neutral-500 text-center pt-2">
        å¤šå·´èƒºä»åœ¨åˆ†æ³Œä¸­
      </footer>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://pwfglucsclutdrwnhuhz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3ZmdsdWNzY2x1dGRyd25odWh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0ODMwOTAsImV4cCI6MjA4NDA1OTA5MH0.5OLlw_rzO3SaQZqDHeZ8_iBwlJgNOtQMa3OlhdpAzrM';
    const TABLE = 'offwork_status';
    const ME_ID = 'me';

    const STATUSES = [
      { label: 'æ‘¸é±¼ä¸­', icon: 'ğŸŸ' },
      { label: 'å¿™æˆç‹—', icon: 'ğŸ•â€ğŸ¦º' },
      { label: 'ä¼šè®®åœ°ç‹±', icon: 'ğŸ”¥' },
      { label: 'æ‹‰å±ä¸­', icon: 'ğŸš½' },
      { label: 'å‡è£…å¾ˆå¿™', icon: 'ğŸ­' },
      { label: 'å³å°†è§£æ”¾', icon: 'ğŸ•Šï¸' },
      { label: 'ä»Šæ™šæ— äº†', icon: 'ğŸ’€' }
    ];


    let currentStatus = STATUSES[0];

    const statusButtons = document.getElementById('statusButtons');
    STATUSES.forEach(s => {
      const btn = document.createElement('button');
      btn.innerHTML = `<span class=\"text-xl\">${s.icon}</span><span class=\"text-sm\">${s.label}</span>`;
      btn.className = 'flex flex-col items-center justify-center gap-1 rounded-2xl border px-2 py-3 text-sm bg-white/60 hover:bg-black hover:text-white transition';
      btn.onclick = () => {
        currentStatus = s;
        [...statusButtons.children].forEach(b => b.classList.remove('bg-black','text-white'));
        btn.classList.add('bg-black','text-white');
      };
      statusButtons.appendChild(btn);
    });
    statusButtons.children[0].classList.add('bg-black','text-white');

    async function fetchStatus() {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}?select=*`, {
        headers: {
          apikey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`
        }
      });
      const data = await res.json();
      render(data);
    }

    function timeAgo(ts) {
      const diff = Math.floor((Date.now() - new Date(ts)) / 60000);
      if (diff < 1) return 'åˆšåˆš';
      if (diff < 60) return `${diff} åˆ†é’Ÿå‰`;
      return `${Math.floor(diff / 60)} å°æ—¶å‰`;
    }

    function statusIcon(status) {
      const map = {
        'æ‘¸é±¼ä¸­': 'ğŸŸ',
        'å¿™æˆç‹—': 'ğŸ•â€ğŸ¦º',
        'ä¼šè®®åœ°ç‹±': 'ğŸ”¥',
        'æ‹‰å±ä¸­': 'ğŸš½',
        'å‡è£…å¾ˆå¿™': 'ğŸ­',
        'å³å°†è§£æ”¾': 'ğŸ•Šï¸',
        'ä»Šæ™šæ— äº†': 'ğŸ’€'
      };
      return map[status] || 'â“';
    }

    function render(list) {
      const el = document.getElementById('statusList');
      el.innerHTML = '';
      list.forEach(item => {
        const card = document.createElement('div');
        card.className = 'rounded-2xl p-4 bg-gradient-to-br from-yellow-200 via-pink-200 to-purple-200';
        card.innerHTML = `
          <div class="text-xl font-bold">${item.name}</div>
          <div class="mt-1 text-lg">${statusIcon(item.status)} ${item.status}</div>
          <div class="text-sm">æœ€æ—©ä¸‹ç­ï¼š${item.offwork_time || 'æœªçŸ¥'}</div>
          <div class="text-xs text-neutral-600 mt-1">${timeAgo(item.updated_at)}</div>
        `;
        el.appendChild(card);
      });
    }

    document.getElementById('updateBtn').onclick = async () => {
      const time = document.getElementById('timeInput').value;

      await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}?id=eq.${ME_ID}`, {
        method: 'PATCH',
        headers: {
          apikey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          Prefer: 'return=minimal'
        },
        body: JSON.stringify({
          status: currentStatus.label,
          offwork_time: time,
          updated_at: new Date().toISOString()
        })
      });

      fetchStatus();
    };

    fetchStatus();
    setInterval(fetchStatus, 60000);
  </script>
</body>
</html>
